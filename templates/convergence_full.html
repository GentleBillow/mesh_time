<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MeshTime Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>

<body class="bg-gray-900 text-gray-100">
  <div class="container mx-auto p-6 max-w-7xl">

    <div class="mb-8">
      <h1 class="text-4xl font-bold mb-2">MeshTime Dashboard</h1>
      <p class="text-gray-400">Real-time synchronization, link quality, and controller analysis</p>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
      <div class="bg-gray-800 rounded-lg p-4">
        <div class="text-sm text-gray-400 mb-1">Sync Quality</div>
        <div id="stat-quality" class="text-2xl font-bold">--</div>
        <div class="text-xs text-gray-500">max deviation (ms)</div>
      </div>

      <div class="bg-gray-800 rounded-lg p-4 border-l-4 border-red-500">
        <div class="text-sm text-gray-400 mb-1">Node A</div>
        <div id="stat-a" class="text-2xl font-bold">--</div>
        <div class="text-xs text-gray-500">current deviation (ms)</div>
      </div>

      <div class="bg-gray-800 rounded-lg p-4 border-l-4 border-green-500">
        <div class="text-sm text-gray-400 mb-1">Node B</div>
        <div id="stat-b" class="text-2xl font-bold">--</div>
        <div class="text-xs text-gray-500">current deviation (ms)</div>
      </div>

      <div class="bg-gray-800 rounded-lg p-4 border-l-4 border-blue-500">
        <div class="text-sm text-gray-400 mb-1">Node C</div>
        <div id="stat-c" class="text-2xl font-bold">--</div>
        <div class="text-xs text-gray-500">current deviation (ms)</div>
      </div>
    </div>

    <div class="bg-gray-800 rounded-lg p-6 mb-8">
      <h2 class="text-2xl font-bold mb-6 flex items-center">
        <span class="text-3xl mr-3">üìä</span> Synchronization Quality
      </h2>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div>
          <h3 class="text-lg font-semibold mb-3">Convergence Timeline</h3>
          <canvas id="convergence-chart"></canvas>
        </div>
        <div>
          <h3 class="text-lg font-semibold mb-3">Deviation Distribution</h3>
          <canvas id="histogram-chart"></canvas>
        </div>
      </div>
    </div>

    <div class="bg-gray-800 rounded-lg p-6 mb-8">
      <h2 class="text-2xl font-bold mb-6 flex items-center">
        <span class="text-3xl mr-3">üîó</span> Link Quality Metrics
      </h2>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div>
          <h3 class="text-lg font-semibold mb-3">RTT Timeline</h3>
          <canvas id="rtt-chart"></canvas>
        </div>
        <div>
          <h3 class="text-lg font-semibold mb-3">Link Asymmetry</h3>
          <canvas id="asymmetry-chart"></canvas>
        </div>
        <div>
          <h3 class="text-lg font-semibold mb-3">Jitter (Rolling Std)</h3>
          <canvas id="jitter-chart"></canvas>
        </div>
        <div>
          <h3 class="text-lg font-semibold mb-3">Link Statistics</h3>
          <canvas id="stats-chart"></canvas>
        </div>
      </div>
    </div>

    <div class="bg-gray-800 rounded-lg p-6 mb-8">
      <h2 class="text-2xl font-bold mb-6 flex items-center">
        <span class="text-3xl mr-3">‚öôÔ∏è</span> Controller Diagnostics
      </h2>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div>
          <h3 class="text-lg font-semibold mb-3">Desired vs Applied Œî</h3>
          <canvas id="controller-delta-chart"></canvas>
        </div>
        <div>
          <h3 class="text-lg font-semibold mb-3">Slew Clipping Rate</h3>
          <canvas id="controller-clip-chart"></canvas>
        </div>
      </div>
    </div>

    <div class="bg-gray-800 rounded-lg p-6 mb-8">
      <h2 class="text-2xl font-bold mb-6 flex items-center">
        <span class="text-3xl mr-3">üî¨</span> Kalman Filter Internals
      </h2>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div>
          <h3 class="text-lg font-semibold mb-3">1) Kalman State (Offset, Drift)</h3>
          <canvas id="kalman-state-chart"></canvas>
        </div>
        <div>
          <h3 class="text-lg font-semibold mb-3">2) Kalman Covariance (P)</h3>
          <canvas id="kalman-cov-chart"></canvas>
        </div>
        <div>
          <h3 class="text-lg font-semibold mb-3">3) Innovation (Residuals)</h3>
          <canvas id="kalman-innov-chart"></canvas>
        </div>
        <div>
          <h3 class="text-lg font-semibold mb-3">4) NIS (Normalized Innovation Squared)</h3>
          <canvas id="kalman-nis-chart"></canvas>
        </div>
        <div>
          <h3 class="text-lg font-semibold mb-3">5) Effective Measurement Noise (R)</h3>
          <canvas id="kalman-r-chart"></canvas>
        </div>
        <div>
          <h3 class="text-lg font-semibold mb-3">6) Controller Slew Detail</h3>
          <canvas id="kalman-slew-chart"></canvas>
        </div>
      </div>
    </div>

    <div class="text-center text-sm text-gray-500">
      <span id="update-info">Starting‚Ä¶</span> |
      Window: 600s |
      Last update: <span id="time-info">--</span>
    </div>
  </div>

<script>
  let charts = {};

  const colors = {
    'A': {line: 'rgb(200, 50, 50)', fill: 'rgba(200, 50, 50, 0.3)'},
    'B': {line: 'rgb(50, 200, 50)', fill: 'rgba(50, 200, 50, 0.3)'},
    'C': {line: 'rgb(100, 149, 237)', fill: 'rgba(100, 149, 237, 0.3)'}
  };

  const linkColors = {
    'A-B': {line: 'rgb(255, 255, 0)', fill: 'rgba(255, 255, 0, 0.3)'},
    'A-C': {line: 'rgb(255, 0, 255)', fill: 'rgba(255, 0, 255, 0.3)'},
    'B-C': {line: 'rgb(0, 255, 255)', fill: 'rgba(0, 255, 255, 0.3)'}
  };

  const baseOptions = {
    responsive: true,
    maintainAspectRatio: true,
    aspectRatio: 2,
    animation: false,
    scales: {
      x: {
        type: 'linear',
        ticks: {
          color: '#9ca3af',
          callback: function(value) {
            const date = new Date(value * 1000);
            return date.toLocaleTimeString('de-DE', {hour: '2-digit', minute: '2-digit'});
          }
        },
        grid: { color: '#374151' }
      },
      y: {
        ticks: { color: '#9ca3af' },
        grid: { color: '#374151' }
      }
    },
    plugins: { legend: { labels: { color: '#9ca3af' } } }
  };

  // --------------------------------------------------------------------------
  // Fetch helpers: timeout + abort previous in-flight per endpoint
  // --------------------------------------------------------------------------
  const inflight = new Map(); // url -> AbortController

  async function fetchJSON(url, timeoutMs=1500) {
    // abort previous request to same URL to prevent piling up
    const prev = inflight.get(url);
    if (prev) prev.abort();

    const ctrl = new AbortController();
    inflight.set(url, ctrl);

    const timer = setTimeout(() => ctrl.abort(), timeoutMs);

    try {
      const res = await fetch(url, { signal: ctrl.signal, cache: "no-store" });
      if (!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}`);
      return await res.json();
    } finally {
      clearTimeout(timer);
      // Only clear if still current controller
      if (inflight.get(url) === ctrl) inflight.delete(url);
    }
  }

  function nowStr() {
    return new Date().toLocaleTimeString('de-DE');
  }

  // --------------------------------------------------------------------------
  // Charts init
  // --------------------------------------------------------------------------
  function initCharts() {
    charts.convergence = new Chart(document.getElementById('convergence-chart'), {
      type: 'line',
      data: {datasets: []},
      options: {...baseOptions,
        scales: {...baseOptions.scales,
          y: {...baseOptions.scales.y, title: {display: true, text: 'Deviation (ms)', color: '#9ca3af'}}
        }
      }
    });

    charts.histogram = new Chart(document.getElementById('histogram-chart'), {
      type: 'bar',
      data: {labels: [], datasets: []},
      options: {...baseOptions,
        scales: {...baseOptions.scales,
          x: {ticks: {color:'#9ca3af'}, grid:{color:'#374151'}, title:{display:true, text:'Deviation (ms)', color:'#9ca3af'}},
          y: {...baseOptions.scales.y, title:{display:true, text:'Count', color:'#9ca3af'}}
        }
      }
    });

    charts.rtt = new Chart(document.getElementById('rtt-chart'), {
      type: 'line',
      data: {datasets: []},
      options: {...baseOptions,
        scales: {...baseOptions.scales,
          y: {...baseOptions.scales.y, title:{display:true, text:'RTT (ms)', color:'#9ca3af'}}
        }
      }
    });

    charts.asymmetry = new Chart(document.getElementById('asymmetry-chart'), {
      type: 'line',
      data: {datasets: []},
      options: {...baseOptions,
        scales: {...baseOptions.scales,
          y: {...baseOptions.scales.y, title:{display:true, text:'Asymmetry (ms)', color:'#9ca3af'}}
        }
      }
    });

    charts.jitter = new Chart(document.getElementById('jitter-chart'), {
      type: 'line',
      data: {datasets: []},
      options: {...baseOptions,
        scales: {...baseOptions.scales,
          y: {...baseOptions.scales.y, title:{display:true, text:'Jitter (ms)', color:'#9ca3af'}}
        }
      }
    });

    charts.stats = new Chart(document.getElementById('stats-chart'), {
      type: 'bar',
      data: {labels: ['A-B','A-C','B-C'], datasets: []},
      options: {...baseOptions,
        scales: {...baseOptions.scales,
          x: {ticks:{color:'#9ca3af'}, grid:{color:'#374151'}},
          y: {...baseOptions.scales.y, title:{display:true, text:'Avg RTT (ms)', color:'#9ca3af'}}
        },
        plugins: {legend: {display:false}}
      }
    });

    charts.controllerDelta = new Chart(document.getElementById('controller-delta-chart'), {
      type: 'line',
      data: {datasets: []},
      options: {...baseOptions,
        scales: {...baseOptions.scales,
          y: {...baseOptions.scales.y, title:{display:true, text:'Œî (ms)', color:'#9ca3af'}}
        }
      }
    });

    charts.controllerClip = new Chart(document.getElementById('controller-clip-chart'), {
      type: 'bar',
      data: {labels: ['A','B','C'], datasets: []},
      options: {...baseOptions,
        scales: {...baseOptions.scales,
          x: {ticks:{color:'#9ca3af'}, grid:{color:'#374151'}},
          y: {...baseOptions.scales.y, title:{display:true, text:'Clip Rate (%)', color:'#9ca3af'}}
        },
        plugins: {legend: {display:false}}
      }
    });

    charts.kalmanState = new Chart(document.getElementById('kalman-state-chart'), {
      type: 'line',
      data: {datasets: []},
      options: {...baseOptions,
        scales: {...baseOptions.scales,
          y: {...baseOptions.scales.y, title:{display:true, text:'x_offset (ms)', color:'#9ca3af'}},
          y2: {type:'linear', position:'right', grid:{drawOnChartArea:false}, ticks:{color:'#9ca3af'},
               title:{display:true, text:'x_drift (ppm)', color:'#9ca3af'}}
        }
      }
    });

    charts.kalmanCov = new Chart(document.getElementById('kalman-cov-chart'), {
      type: 'line',
      data: {datasets: []},
      options: {...baseOptions,
        scales: {...baseOptions.scales,
          y: {type:'logarithmic', ticks:{color:'#9ca3af'}, grid:{color:'#374151'},
              title:{display:true, text:'p_offset (ms¬≤)', color:'#9ca3af'}},
          y2:{type:'logarithmic', position:'right', grid:{drawOnChartArea:false}, ticks:{color:'#9ca3af'},
              title:{display:true, text:'p_drift (ppm¬≤)', color:'#9ca3af'}}
        }
      }
    });

    charts.kalmanInnov = new Chart(document.getElementById('kalman-innov-chart'), {
      type:'line',
      data:{datasets:[]},
      options:{...baseOptions,
        scales:{...baseOptions.scales,
          y:{...baseOptions.scales.y, title:{display:true, text:'Innovation (ms)', color:'#9ca3af'}}
        }
      }
    });

    charts.kalmanNIS = new Chart(document.getElementById('kalman-nis-chart'), {
      type:'line',
      data:{datasets:[]},
      options:{...baseOptions,
        scales:{...baseOptions.scales,
          y:{...baseOptions.scales.y, title:{display:true, text:'NIS', color:'#9ca3af'}}
        }
      }
    });

    charts.kalmanR = new Chart(document.getElementById('kalman-r-chart'), {
      type:'line',
      data:{datasets:[]},
      options:{...baseOptions,
        scales:{...baseOptions.scales,
          y:{type:'logarithmic', ticks:{color:'#9ca3af'}, grid:{color:'#374151'},
             title:{display:true, text:'r_eff (ms¬≤)', color:'#9ca3af'}}
        }
      }
    });

    charts.kalmanSlew = new Chart(document.getElementById('kalman-slew-chart'), {
      type:'line',
      data:{datasets:[]},
      options:{...baseOptions,
        scales:{...baseOptions.scales,
          y:{...baseOptions.scales.y, title:{display:true, text:'Œî (ms)', color:'#9ca3af'}}
        }
      }
    });
  }

  // --------------------------------------------------------------------------
  // Data caches (controller reused by slew plot)
  // --------------------------------------------------------------------------
  let controllerCache = null;
  let controllerCacheTs = 0;

  // --------------------------------------------------------------------------
  // Update functions
  // --------------------------------------------------------------------------
  async function updateSync() {
    const data = await fetchJSON('/api/sync', 1500);

    document.getElementById('stat-quality').textContent =
      (data.stats.max_abs_ms != null) ? data.stats.max_abs_ms.toFixed(3) : '--';

    ['A','B','C'].forEach(nid => {
      const el = document.getElementById(`stat-${nid.toLowerCase()}`);
      const v = data.stats.nodes?.[nid]?.current_ms;
      el.textContent = (v != null) ? Number(v).toFixed(3) : '--';
    });

    const ds = ['A','B','C'].map(nid => ({
      label: `Node ${nid}`,
      data: data.timeseries.timestamps.map((t,i)=>({x:t, y: data.timeseries.deviations[nid][i]})),
      borderColor: colors[nid].line,
      backgroundColor: colors[nid].fill,
      borderWidth: 1,
      pointRadius: 0,
      spanGaps: false
    }));
    charts.convergence.data.datasets = ds;
    charts.convergence.update('none');

    const binCenters = data.histogram.bin_edges.slice(0,-1).map((edge,i)=>
      ((edge + data.histogram.bin_edges[i+1])/2).toFixed(2)
    );
    const hds = ['A','B','C'].map(nid => ({
      label: `Node ${nid}`,
      data: data.histogram.counts[nid],
      backgroundColor: colors[nid].fill,
      borderColor: colors[nid].line,
      borderWidth: 1
    }));
    charts.histogram.data.labels = binCenters;
    charts.histogram.data.datasets = hds;
    charts.histogram.update('none');
  }

  async function updateLinks() {
    const data = await fetchJSON('/api/links', 2000);

    const rttDS = ['A-B','A-C','B-C'].map(id => {
      const d = data.timeseries[id];
      return {
        label: id,
        data: d.timestamps.map((t,i)=>({x:t, y:d.rtt[i]})),
        borderColor: linkColors[id].line,
        backgroundColor: linkColors[id].fill,
        borderWidth: 1,
        pointRadius: 0,
        spanGaps: false
      };
    });
    charts.rtt.data.datasets = rttDS;
    charts.rtt.update('none');

    const asymDS = ['A-B','A-C','B-C'].map(id => {
      const d = data.timeseries[id];
      return {
        label: id,
        data: d.timestamps.map((t,i)=>({x:t, y:d.asymmetry[i]})),
        borderColor: linkColors[id].line,
        backgroundColor: linkColors[id].fill,
        borderWidth: 1,
        pointRadius: 0,
        spanGaps: false
      };
    });
    charts.asymmetry.data.datasets = asymDS;
    charts.asymmetry.update('none');

    const jitDS = ['A-B','A-C','B-C'].map(id => {
      const d = data.jitter[id];
      return {
        label: id,
        data: d.timestamps.map((t,i)=>({x:t, y:d.jitter[i]})),
        borderColor: linkColors[id].line,
        backgroundColor: linkColors[id].fill,
        borderWidth: 1,
        pointRadius: 0,
        spanGaps: false
      };
    });
    charts.jitter.data.datasets = jitDS;
    charts.jitter.update('none');

    const avgRtts = ['A-B','A-C','B-C'].map(id => data.stats[id].avg_rtt);
    charts.stats.data.datasets = [{
      label: 'Avg RTT',
      data: avgRtts,
      backgroundColor: ['A-B','A-C','B-C'].map(id => linkColors[id].fill),
      borderColor: ['A-B','A-C','B-C'].map(id => linkColors[id].line),
      borderWidth: 1
    }];
    charts.stats.update('none');
  }

  async function updateController() {
    const data = await fetchJSON('/api/controller', 1500);
    controllerCache = data;
    controllerCacheTs = Date.now();

    const ds = [];
    ['A','B','C'].forEach(nid => {
      const d = data.timeseries[nid];
      ds.push({
        label: `${nid} desired`,
        data: d.timestamps.map((t,i)=>({x:t, y:d.desired[i]})),
        borderColor: colors[nid].line,
        backgroundColor: colors[nid].fill,
        borderWidth: 1,
        pointRadius: 0,
        borderDash: [5,5],
        spanGaps: false
      });
      ds.push({
        label: `${nid} applied`,
        data: d.timestamps.map((t,i)=>({x:t, y:d.applied[i]})),
        borderColor: colors[nid].line,
        backgroundColor: colors[nid].fill,
        borderWidth: 1,
        pointRadius: 0,
        spanGaps: false
      });
    });
    charts.controllerDelta.data.datasets = ds;
    charts.controllerDelta.update('none');

    const clipRates = ['A','B','C'].map(nid => (data.stats[nid].clip_rate || 0) * 100);
    charts.controllerClip.data.datasets = [{
      label: 'Clip Rate',
      data: clipRates,
      backgroundColor: ['A','B','C'].map(nid => colors[nid].fill),
      borderColor: ['A','B','C'].map(nid => colors[nid].line),
      borderWidth: 1
    }];
    charts.controllerClip.update('none');
  }

  async function updateKalman() {
    const k = await fetchJSON('/api/kalman/all', 2500);

    // 1) State
    const stateDS = [];
    ['A','B','C'].forEach(nid => {
      const d = k.data[nid];
      stateDS.push({
        label: `${nid} x_offset`,
        data: d.timestamps.map((t,i)=>({x:t, y:d.x_offset_ms[i]})),
        borderColor: colors[nid].line,
        backgroundColor: colors[nid].fill,
        borderWidth: 1,
        pointRadius: 0,
        yAxisID: 'y',
        spanGaps: false
      });
      stateDS.push({
        label: `${nid} x_drift`,
        data: d.timestamps.map((t,i)=>({x:t, y:d.x_drift_ppm[i]})),
        borderColor: colors[nid].line,
        backgroundColor: colors[nid].fill,
        borderWidth: 1,
        pointRadius: 0,
        borderDash: [5,5],
        yAxisID: 'y2',
        spanGaps: false
      });
    });
    charts.kalmanState.data.datasets = stateDS;
    charts.kalmanState.update('none');

    // 2) Covariance
    const covDS = [];
    ['A','B','C'].forEach(nid => {
      const d = k.data[nid];
      covDS.push({
        label: `${nid} p_offset`,
        data: d.timestamps.map((t,i)=>({x:t, y:d.p_offset_ms2[i]})),
        borderColor: colors[nid].line,
        backgroundColor: colors[nid].fill,
        borderWidth: 1,
        pointRadius: 0,
        yAxisID: 'y',
        spanGaps: false
      });
      covDS.push({
        label: `${nid} p_drift`,
        data: d.timestamps.map((t,i)=>({x:t, y:d.p_drift_ppm2[i]})),
        borderColor: colors[nid].line,
        backgroundColor: colors[nid].fill,
        borderWidth: 1,
        pointRadius: 0,
        borderDash: [5,5],
        yAxisID: 'y2',
        spanGaps: false
      });
    });
    charts.kalmanCov.data.datasets = covDS;
    charts.kalmanCov.update('none');

    // 3) Innovation
    const innovDS = [];
    ['A','B','C'].forEach(nid => {
      const d = k.data[nid];
      innovDS.push({
        label: `${nid} innov_med`,
        data: d.timestamps.map((t,i)=>({x:t, y:d.innov_med_ms[i]})),
        borderColor: colors[nid].line,
        backgroundColor: colors[nid].fill,
        borderWidth: 1,
        pointRadius: 0,
        spanGaps: false
      });
      innovDS.push({
        label: `${nid} innov_p95`,
        data: d.timestamps.map((t,i)=>({x:t, y:d.innov_p95_ms[i]})),
        borderColor: colors[nid].line,
        backgroundColor: colors[nid].fill,
        borderWidth: 1,
        pointRadius: 0,
        borderDash: [5,5],
        spanGaps: false
      });
    });
    charts.kalmanInnov.data.datasets = innovDS;
    charts.kalmanInnov.update('none');

    // 4) NIS
    const nisDS = [];
    ['A','B','C'].forEach(nid => {
      const d = k.data[nid];
      nisDS.push({
        label: `${nid} nis_med`,
        data: d.timestamps.map((t,i)=>({x:t, y:d.nis_med[i]})),
        borderColor: colors[nid].line,
        backgroundColor: colors[nid].fill,
        borderWidth: 1,
        pointRadius: 0,
        spanGaps: false
      });
      nisDS.push({
        label: `${nid} nis_p95`,
        data: d.timestamps.map((t,i)=>({x:t, y:d.nis_p95[i]})),
        borderColor: colors[nid].line,
        backgroundColor: colors[nid].fill,
        borderWidth: 1,
        pointRadius: 0,
        borderDash: [5,5],
        spanGaps: false
      });
    });
    charts.kalmanNIS.data.datasets = nisDS;
    charts.kalmanNIS.update('none');

    // 5) R_eff
    const rDS = [];
    ['A','B','C'].forEach(nid => {
      const d = k.data[nid];
      rDS.push({
        label: `${nid} r_eff`,
        data: d.timestamps.map((t,i)=>({x:t, y:d.r_eff_ms2[i]})),
        borderColor: colors[nid].line,
        backgroundColor: colors[nid].fill,
        borderWidth: 1,
        pointRadius: 0,
        spanGaps: false
      });
    });
    charts.kalmanR.data.datasets = rDS;
    charts.kalmanR.update('none');

    // 6) Slew detail from cached controller (NO extra fetch)
    const ctrl = controllerCache;
    if (ctrl && ctrl.timeseries) {
      const slewDS = [];
      ['A','B','C'].forEach(nid => {
        const d = ctrl.timeseries[nid];

        slewDS.push({
          label: `${nid} desired`,
          data: d.timestamps.map((t,i)=>({x:t, y:d.desired[i]})),
          borderColor: colors[nid].line,
          backgroundColor: colors[nid].fill,
          borderWidth: 1,
          pointRadius: 0,
          borderDash: [5,5],
          spanGaps: false
        });

        slewDS.push({
          label: `${nid} applied`,
          data: d.timestamps.map((t,i)=>({x:t, y:d.applied[i]})),
          borderColor: colors[nid].line,
          backgroundColor: colors[nid].fill,
          borderWidth: 1,
          pointRadius: 0,
          spanGaps: false
        });

        const clippedPoints = [];
        d.timestamps.forEach((t,i) => {
          if (d.clipped[i] === 1) {
            const y = (d.applied[i] != null) ? d.applied[i] : d.desired[i];
            if (y != null) clippedPoints.push({x:t, y:y});
          }
        });

        if (clippedPoints.length) {
          slewDS.push({
            label: `${nid} clipped`,
            data: clippedPoints,
            type: 'scatter',
            borderColor: colors[nid].line,
            backgroundColor: colors[nid].line,
            pointRadius: 4,
            pointHoverRadius: 6
          });
        }
      });

      charts.kalmanSlew.data.datasets = slewDS;
      charts.kalmanSlew.update('none');
    }
  }

  // --------------------------------------------------------------------------
  // Polling (decoupled) + backoff
  // --------------------------------------------------------------------------
  let stopped = false;
  let backoffMs = 0;
  let backoffTimer = null;

  const running = {
    sync: false,
    links: false,
    controller: false,
    kalman: false
  };

  function setStatus(text) {
    document.getElementById('update-info').textContent = text;
    document.getElementById('time-info').textContent = nowStr();
  }

  function scheduleBackoff() {
    if (backoffTimer) return;
    backoffMs = Math.min(backoffMs ? backoffMs * 2 : 2000, 30000);
    setStatus(`Error (retry in ${(backoffMs/1000).toFixed(0)}s)`);
    backoffTimer = setTimeout(() => {
      backoffTimer = null;
      // one "kick" per loop
      pollSync();
      pollController();
      pollLinks();
      pollKalman();
      setStatus("Live");
    }, backoffMs);
  }

  async function safeRun(key, fn) {
    if (stopped) return;
    if (backoffTimer) return;       // if in backoff, do nothing
    if (running[key]) return;       // prevent overlap
    running[key] = true;
    try {
      await fn();
      setStatus("Live");
      backoffMs = 0;                // success resets backoff
    } catch (e) {
      console.error(`[${key}]`, e);
      scheduleBackoff();
    } finally {
      running[key] = false;
    }
  }

  // Intervals:
  //  - sync: 2.5s
  //  - controller: 2.5s
  //  - links: 7.5s
  //  - kalman: 15s
  const T_SYNC = 2500;
  const T_CTRL = 2500;
  const T_LINK = 7500;
  const T_KAL  = 15000;

  let tSync=null, tCtrl=null, tLink=null, tKal=null;

  function pollSync()      { safeRun('sync', updateSync); }
  function pollController(){ safeRun('controller', updateController); }
  function pollLinks()     { safeRun('links', updateLinks); }
  function pollKalman()    { safeRun('kalman', updateKalman); }

  function startPolling() {
    // initial burst (but controlled)
    pollSync();
    pollController();
    pollLinks();
    pollKalman();

    tSync = setInterval(pollSync, T_SYNC);
    tCtrl = setInterval(pollController, T_CTRL);
    tLink = setInterval(pollLinks, T_LINK);
    tKal  = setInterval(pollKalman, T_KAL);
  }

  window.addEventListener('load', () => {
    initCharts();
    startPolling();
  });
</script>
</body>
</html>
